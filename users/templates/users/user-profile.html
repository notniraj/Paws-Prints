{% extends 'portal/layout.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block body %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6 my-4">
            <h2>User Profile</h2>
            <hr>
            <div id="user-info">
                <img src="{% get_media_prefix %}{{ user.profile_picture }}" alt="Profile Picture" class="img-fluid rounded-circle mb-3" style="height: 12em;">
                <p><strong>Username:</strong> {{ user.username }}</p>
                <p><strong>Email:</strong> {{ user.email }}</p>
                <p><strong>User Type:</strong> {{ user.user_type }}</p>
                <p><strong>First Name:</strong> {{ user.first_name }}</p>
                <p><strong>Last Name:</strong> {{ user.last_name }}</p>
                <p><strong>Address:</strong> {{ user.address }}</p>
                <p><strong>Contact:</strong> {{ user.contact }}</p>
                <p><strong>Date of Birth:</strong> {{ user.date_of_birth }}</p>
            </div>
            <form id="edit-form" method="post" action="{% url 'users:user-profile' %}" style="display: none;">
                {% csrf_token %}
                <div class="form-group">
                    {{ edit_form.profile_picture|as_crispy_field }}
                </div>
                <div class="form-group">
                    {{ edit_form.email|as_crispy_field}}
                </div>
                <div class="form-group">
                    {{ edit_form.password| as_crispy_field }}
                </div>
                <div class="form-group">
                    {{ edit_form.user_type|as_crispy_field}}
                </div>
                <div class="form-group">
                    {{ edit_form.first_name|as_crispy_field}}
                </div>
                <div class="form-group">
                    {{ edit_form.last_name|as_crispy_field}}
                </div>
                <div class="form-group">
                    {{ edit_form.address|as_crispy_field}}
                </div>
                <div class="form-group">
                    {{ edit_form.contact|as_crispy_field}}
                </div>
                <div class="form-group">
                    {{ edit_form.date_of_birth|as_crispy_field}}
                </div>
                <div class="my-4">
                    <button type="submit" class="btn btn-primary" name="edit_profile">Save Changes</button>
                    <button type="button" class="btn btn-secondary" id="cancel-edit">Cancel</button>
                </div>
            </form>
            <div class="d-flex justify-content-start align-items-center gap-5">
                <button id="edit-btn" class="btn btn-primary">Edit Profile</button>
                <form method="post" action="{% url 'users:user-profile' %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" name="delete_profile" onclick="return confirm('Are you sure you want to delete your profile? Deleting your profile deletes your pet information too.%')">Delete Profile</button>
                </form> 
            </div>
        </div>
        <div class="col-md-6 my-4">
            <h2>Pets</h2>
            <hr>
            <ul class="list-group">
                {% for pet in user.petmodel_set.all %}
                    <li class="list-group-item">
                        {{ pet.pet_name }} - {{ pet.pet_type }}
                        <!-- Edit Button for Each Pet -->
                        <button type="button" class="btn btn-sm btn-primary float-right mr-2 edit-pet-btn" data-pet-id="{{ pet.id }}">Edit</button>
                        <!-- Edit Form for Each Pet (Initially Hidden) -->
                        <form method="post" action="{% url 'users:user-profile' %}" class="edit-pet-form" style="display: none;">
                            {% csrf_token %}
                            <input type="hidden" name="edit_pet" value="{{ pet.id }}">
                            {{ pet_form|crispy }}
                            <button type="submit" class="btn btn-sm btn-success float-right">Save</button>
                        </form>
                        <!-- Delete Button for Each Pet -->
                        <form method="post" action="{% url 'users:user-profile' %}" class="delete-pet-form">
                            {% csrf_token %}
                            <input type="hidden" name="delete_pet" value="{{ pet.id }}">
                            <button type="submit" class="btn btn-sm btn-danger float-right" onclick="return confirm('Are you sure you want to delete this pet?')">Delete</button>
                        </form>
                    </li>
                {% empty %}
                    <li class="list-group-item">No pets found.</li>
                {% endfor %}
            </ul>
            <!-- Add Pet Button (Initially Visible) -->
            <button id="add-pet-btn" class="btn btn-primary mt-3">Add Pet</button>
            <!-- Add Pet Form (Initially Hidden) -->
            <div id="add-pet-form" style="display: none;">
                <h3>Add Pet</h3>
                <form method="post" enctype="multipart/form-data" action="{% url 'users:user-profile' %}">
                    {% csrf_token %}
                    {{ pet_form|crispy }}
                    <button type="submit" class="btn btn-success">Add Pet</button>
                    <!-- Cancel Button to Hide the Form -->
                    <button type="button" class="btn btn-danger" id="cancel-add-pet">Cancel</button>
                </form>
            </div>
        </div>          
    </div>
</div>

<script>
    document.getElementById('edit-btn').addEventListener('click', function() {
        document.getElementById('user-info').style.display = 'none';
        document.getElementById('edit-form').style.display = 'block';
        document.getElementById('edit-btn').style.display = 'none'; // Hide the "Edit Profile" button
    });

    document.getElementById('cancel-edit').addEventListener('click', function() {
        document.getElementById('edit-form').style.display = 'none';
        document.getElementById('user-info').style.display = 'block';
        document.getElementById('edit-btn').style.display = 'block'; // Show the "Edit Profile" button
    });


    // Edit Button Click Event
    document.querySelectorAll('.edit-pet-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            var petId = this.getAttribute('data-pet-id');
            // Hide the original Add Pet button
            document.getElementById('add-pet-btn').style.display = 'none';
            // Hide all other edit forms
            document.querySelectorAll('.edit-pet-form').forEach(function(form) {
                form.style.display = 'none';
            });
            // Show the edit form for the clicked pet
            document.querySelector('.edit-pet-form[data-pet-id="' + petId + '"]').style.display = 'block';
        });
    });

    // Add Pet Button Click Event
    document.getElementById('add-pet-btn').addEventListener('click', function() {
        // Hide the original Add Pet button
        this.style.display = 'none';
        // Show the Add Pet form
        document.getElementById('add-pet-form').style.display = 'block';
    });

    // Cancel Add Pet Button Click Event
    document.getElementById('cancel-add-pet').addEventListener('click', function() {
        // Hide the Add Pet form
        document.getElementById('add-pet-form').style.display = 'none';
        // Show the original Add Pet button
        document.getElementById('add-pet-btn').style.display = 'block';
    });
</script>
{% endblock %}
